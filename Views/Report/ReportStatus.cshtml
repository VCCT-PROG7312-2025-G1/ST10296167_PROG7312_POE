@model ST10296167_PROG7312_POE.Models.ReportStatusVIewModel

<link href="~/css/report-status.css" rel="stylesheet" />

<!-- Success & Error messages-->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show success-message position-fixed"
         style="top: 80px; right: 20px; z-index: 1100; max-width: 400px;">
        <strong>Success!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show error-message position-fixed"
         style="top: 80px; right: 20px; z-index: 1100; max-width: 400px;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Error!</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Back Button -->
<a asp-action="Index" asp-controller="Home"
   class="btn btn-secondary position-absolute"
   style="top: 100px; left: 10px; z-index: 1000;">
    &larr; Back
</a>

<!-- Page Header -->
<header class="report-status-header text-center">
    <h1 class="main-heading">Service Requests</h1>
    @if (Model.IsEmployee)
    {
        <p class="sub-text">View and manage service requests</p>
    }
    else
    {
        <p class="sub-text">View and track service requests</p>
    }
</header>

<div class="report-status-container">

    <!-- Statistics Card -->
    @if (Model.IsEmployee)
    {
    <div class="statistics-section">
        <div class="statistics-card">
            <div class="statistics-card-header">
                <h3>
                    Statistics
                </h3>
            </div>
            <div class="statistics-card-body">

                <!-- Statistics -->
                <div class="row mb-0">

                    <!-- Total Issues-->
                    <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted stat-label">Total Issues</h6>
                                <h2 class="mb-0 stat-value">@Model.Statistics.TotalIssues</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Submitted Issues-->
                    <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted stat-label">Submitted</h6>
                                <h2 class="mb-0 text-info stat-value">@Model.Statistics.IssuesByStatus.GetValueOrDefault(IssueStatus.Submitted, 0)</h2>
                            </div>
                        </div>
                    </div>

                    <!-- In Progress Issues-->
                    <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted stat-label">In Progress</h6>
                                <h2 class="mb-0 text-warning stat-value">@Model.Statistics.IssuesByStatus.GetValueOrDefault(IssueStatus.InProgress, 0)</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Resolved Issues-->
                    <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted stat-label">Resolved</h6>
                                <h2 class="mb-0 text-success stat-value">@Model.Statistics.IssuesByStatus.GetValueOrDefault(IssueStatus.Resolved, 0)</h2>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    }

    <!-- Requests Card -->
    <div class="requests-section">
        <div class="requests-card">
            <div class="requests-card-header">
                <div class="section-divider">
                    <h3 class="section-title">
                        Requests
                    </h3>
                    <span class="issues-count">@(Model.FilteredIssues?.Count ?? 0) Issues</span>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-section-embedded">
                <form method="get" id="filterForm" class="filter-form" asp-action="ReportStatus">

                    <!-- ID -->
                    <div class="filter-group filter-group-id">
                        <label for="ID">Issue ID</label>
                        <input type="number" class="form-control" id="ID" name="ID"
                               value="@Model.CurrentFilter.ID"
                               placeholder="Enter ID" min="1" step="1"/>
                    </div>

                    <!-- Category -->
                    <div class="filter-group filter-group-category">
                        <label for="Category">Category</label>
                        <select class="form-select" id="Category" name="Category">
                            <option value="">All Categories</option>
                            @{
                                var categories = new[] { "Water", "Electricity", "Road Damage", "Waste Management", "Utilities", "Environment", "Public Transport", "Public Safety", "Other" };
                                foreach (var cat in categories)
                                {
                                    if (Model.CurrentFilter.Category == cat)
                                    {
                                        <option value="@cat" selected>@cat</option>
                                    }
                                    else
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="filter-group filter-group-status">
                        <label for="Status">Status</label>
                        <select class="form-select" id="Status" name="Status">
                            <option value="">All Statuses</option>
                            @{
                                var statuses = new[] { IssueStatus.Submitted, IssueStatus.InProgress, IssueStatus.Resolved };
                                var statusLabels = new Dictionary<IssueStatus, string>
                                {
                                    { IssueStatus.Submitted, "Submitted" },
                                    { IssueStatus.InProgress, "In Progress" },
                                    { IssueStatus.Resolved, "Resolved" }
                                };
                                foreach (var status in statuses)
                                {
                                    if (Model.CurrentFilter.Status == status)
                                    {
                                        <option value="@status" selected>@statusLabels[status]</option>
                                    }
                                    else
                                    {
                                        <option value="@status">@statusLabels[status]</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <!-- Start Date -->
                    <div class="filter-group filter-group-startdate">
                        <label for="StartDate">Start date</label>
                        <input type="date" class="form-control" id="StartDate" name="StartDate"
                               value="@Model.CurrentFilter.StartDate?.ToString("yyyy-MM-dd")"
                               onfocus="this.showPicker()" onchange="this.blur()" />
                    </div>

                    <!-- End Date -->
                    <div class="filter-group filter-group-enddate">
                        <label for="EndDate">End date</label>
                        <input type="date" class="form-control" id="EndDate" name="EndDate"
                               value="@Model.CurrentFilter.EndDate?.ToString("yyyy-MM-dd")"
                               onfocus="this.showPicker()" onchange="this.blur()" />
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-buttons">
                        <button type="submit" class="btn btn-primary">Search</button>
                        @if (Model.CurrentFilter.HasFilters())
                        {
                            <a asp-action="ReportStatus" class="btn btn-outline-dark">Reset</a>
                        }
                        else
                        {
                            <a asp-action="ReportStatus" class="btn btn-outline-dark" style="opacity: 0.5; pointer-events: none; cursor: not-allowed;">Reset</a>
                        }
                    </div>
                </form>

                @if (Model.CurrentFilter.HasFilters())
                {
                    <div class="filter-reset-section">
                        <span class="filter-results-count">Showing @Model.FilteredIssues.Count results</span>
                    </div>
                }
            </div>

            <div class="requests-card-body">

                <!-- Table -->
                @if (Model.FilteredIssues == null || !Model.FilteredIssues.Any())
                {
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h4>No Requests Available</h4>
                        <p>There are no service requests at this time.</p>
                    </div>
                }
                else
                {
                    <div class="table-container">
                        <table class="table table-hover" id="requestsTable">
                            <thead>
                                <tr>
                                    <th>Issue</th>
                                    <th>Category</th>
                                    <th>Location</th>
                                    <th>Date</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Files</th>
                                    <th class="text-center">Actions</th>
                                    <th class="text-center">Related</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                @foreach (var issue in Model.FilteredIssues)
                                {
                                    <tr>
                                        <td>
                                            <div class="issue-id">#@issue.ID</div>
                                        </td>
                                        <td>
                                            <span class="badge category-badge">@issue.Category</span>
                                        </td>
                                        <td>@issue.Location</td>
                                        <td class="date-cell" style="color:grey">@issue.CreatedAt.ToString("MMM dd, yyyy")</td>
                                        <td class="text-center">
                                            @{
                                                var statusClass = issue.Status == IssueStatus.Resolved ? "status-resolved" :
                                                                  issue.Status == IssueStatus.InProgress ? "status-in-progress" :
                                                                  "status-submitted";
                                                var statusText = issue.Status == IssueStatus.Resolved ? "Resolved" :
                                                                 issue.Status == IssueStatus.InProgress ? "InProgress" :
                                                                 "Submitted";
                                            }
                                            <span class="badge @statusClass">@(statusText == "InProgress" ? "In Progress" : statusText)</span>
                                        </td>
                                        <td class="text-center">
                                            @if (issue.Files != null && issue.Files.Any())
                                            {
                                                <span class="file-count">@issue.Files.Count</span>
                                            }
                                            else
                                            {
                                                <span class="file-count">0</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="action-buttons-container">
                                                <a asp-action="ReportDetails" asp-controller="Report" 
                                                   asp-route-issueId="@issue.ID"
                                                   class="view-details-link" 
                                                   title="View Details">
                                                    View
                                                </a>
                                                @if (Model.IsEmployee && issue.Status != IssueStatus.Resolved)
                                                {
                                                    <a href="#" 
                                                       class="update-status-link update-status-btn" 
                                                       title="Update Status"
                                                       data-issue-id="@issue.ID"
                                                       data-issue-category="@issue.Category"
                                                       data-issue-status="@((int)issue.Status)">
                                                        Update
                                                    </a>
                                                }
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var relatedCount = Model.RelatedCounts.ContainsKey(issue.ID) ? Model.RelatedCounts[issue.ID] : 0;
                                            }
                                            <span class="related-issues-count">@relatedCount</span>
                                        </td>
                                    </tr>
                                } 
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="paginationContainer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Buttons generated by js -->
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" role="dialog" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header modal-header-update-status">
                <h5 class="modal-title" id="updateStatusModalLabel">
                    Update Status - Issue #<span id="modalIssueId"></span>
                    <span class="modal-category-badge" id="modalIssueCategory"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Dropdown -->
            <form id="updateStatusForm" method="post" asp-action="UpdateStatus" asp-controller="Report">
                <div class="modal-body">
                    <input type="hidden" id="modalIssueIdInput" name="issueId" />
                    
                    <div class="form-group mb-3">
                        <label for="statusSelect" class="form-label fw-bold">Update Progress</label>
                        <select class="form-select" id="statusSelect" name="status" required>
                            <!-- Options populated using js -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="confirmUpdateBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/report-status.js"></script>
